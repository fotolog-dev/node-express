import express from 'express';
import cors from "cors";
  
import bodyParser from "body-parser";
import session, { MemoryStore } from "express-session";
import fs from "fs";

import path from 'path';
import { fileURLToPath } from 'url';
import ejs from 'ejs';
import webpush from 'web-push';

import mssql from "mssql";
import uuid4 from "uuid4";

import { swaggerUi, specs } from './common/swagger.js';


/* var express = require('express'); */
/* var bodyParser = require('body-parser'); */
/* var session = require('express-session'); */
/* var fs = require("fs") */


/*
  [DEP0066] DeprecationWarning: OutgoingMessage.prototype._headers is deprecated in windows
  Ïò§Î•òÍ∞Ä ÎÇ† Í≤ΩÏö∞
  ps> npm audit fix --force 


  * IISÏóê Ïò¨Î¶¨Î†§ Ìï† Í≤ΩÏö∞
  1. ÏúàÎèÑÏö∞ ÏÑ§ÏπòÎ°ú URL REWRITE ÏÑ§Ïπò 
  2. Reverse Proxy ÏÑ†ÌÉùÌõÑ ARR3ÏÑ§Ïπò ÏöîÍµ¨Ïãú ÏúàÎèÑÏö∞ ÏÑ§ÏπòÎ°ú ARR3 ÏÑ§Ïπò localhost:8080 Ìè¨Ìä∏ ÏßÄÏ†ï
  3. NPMÏúºÎ°ú PM2 ÏÑ§Ïπò PM2 START Server.js , Ï§ëÏßÄÏãú PM2 STOP Server.js

     PM2 status(list) : Ïã§ÌñâÏ§ëÏù∏ Ïñ¥ÌîåÎ¶¨ÏºÄÏù¥ÏÖòÏùò ÏÉÅÌÉúÎ•º ÌôïÏù∏ 
     PM2 monit

*/

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

var app = express();

app.use(cors()); // Î™®Îì† http ÏöîÏ≤≠ÏùÑ ÌóàÏö©ÌïúÎã§.
app.use(bodyParser.json());
//app.use(bodyParser.urlencoded()); 
app.use(bodyParser.urlencoded({ extended: true }));

app.use(session({
    secret: '@#@$MYSIGN#@$#$',  // Ïø†ÌÇ§Î•º ÏûÑÏùòÎ°ú Î≥ÄÏ°∞ÌïòÎäîÍ≤ÉÏùÑ Î∞©ÏßÄÌïòÍ∏∞ ÏúÑÌïú sign Í∞í
    resave: false,              // ÏÑ∏ÏÖòÏùÑ Ïñ∏Ï†úÎÇò Ï†ÄÏû•Ìï† ÏßÄ Ï†ïÌïòÎäî Í∞íÏûÖÎãàÎã§. express-session documentationÏóêÏÑúÎäî Ïù¥ Í∞íÏùÑ false Î°ú ÌïòÎäîÍ≤ÉÏùÑ  Í∂åÏû•(ÌïÑÏöîÏóê Îî∞Îùº trueÎ°ú ÏÑ§Ï†ï)
    saveUninitialized: true,    // uninitialized ÏÑ∏ÏÖòÏù¥ÎûÄ ÏÉàÎ°ú ÏÉùÍ≤ºÏßÄÎßå Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏùÄ ÏÑ∏ÏÖòÏùÑ ÏùòÎØ∏Ìï©ÎãàÎã§. DocumentationÏóêÏÑú Ïù¥ Í∞íÏùÑ trueÎ°ú ÏÑ§Ï†ïÌïòÎäîÍ≤ÉÏùÑ Í∂åÏû•
    store: new MemoryStore({
      //checkPeriod: 24 * 60 * 60 * 1000, // 1 day
      checkPeriod: 60 * 1000, // 60 Î∂Ñ 
    }) 
}));

import member_router from './router/member/member.js'
import main_router from './router/main.js'
import bbs_router from './router/bbs/bbs.js'
import chat_client_router from './router/chat_client/chat_client.js'
import WebSocket_router from './router/WebSocket_Sample/WebSocket_Sample.js'
import example_router from './router/example/example.js'

//swagger.js /api-docs ÎùºÎäî pathÎ°ú Îì±Î°ùÏãúÏºúÏ§å.
app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(specs));
 
const member = member_router(app,fs);
app.use('/member', member);

const main = main_router(app);
app.use('/main', main);

const bbs = bbs_router(app, fs);
app.use('/bbs', bbs);

const chat_client = chat_client_router(app,fs);
app.use('/chat_client', chat_client);

const WebSocket_Sample = WebSocket_router(app,fs);
app.use('/WebSocket_Sample', WebSocket_Sample);

const example = example_router(app,fs);
app.use('/example', example);

const options = {
  setHeaders: function (res, path, stat) {
      res.set('Service-Worker-Allowed', '/');
  },
};

app.use(express.static(path.join(process.cwd(), './public'), options));
 
//app.use(express.static('public'));

app.set('views', __dirname + '/views');
app.set('view engine', 'ejs');
//app.engine('html', require('ejs').renderFile);
app.engine('html', ejs.renderFile);

import mysql_connect from './common/mySqlConfig.js';
import mssql_connect_config from './common/MsSqlConfig.js';

//var _err = mysql_connect.init();
 
mysql_connect.connect(function (err) 
{
  if (err) {
    return console.error(`error : ${err}`);
  }
  console.log(`MySQL connection success`);
});

var mssql_connect = new mssql.ConnectionPool(mssql_connect_config);

mssql_connect.connect(function (err)  
{
  if (err) {
    return console.error(`error : ${err}`);
  }

  console.log(`MSSQL connection success`);
  mssql_connect.close();

});

import WebSocket, { WebSocketServer } from "ws";
import {Server} from "socket.io";
 
const web_port = 8080;
//const web_port = 80;
const web_socket_port = 8081; 

var server = app.listen(web_port, function(){
  console.log("Express server has started on port " + web_port);
});

/* var web_socket_server = app.listen(web_socket_port, function(){
  console.log('Socket IO server listening on port ' + web_socket_port);
});  
  */


const io = new Server(server);
/*
// Ï†ÑÏ≤¥ Î≥¥ÎÇ¥Í∏∞
req.app.get('io').emit('Ïù¥Î≤§Ìä∏', Î©îÏÑ∏ÏßÄ);

// ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§Ïóê ÏûàÎäî Ïú†Ï†ÄÌïúÌÖåÎßå Î≥¥ÎÇ¥Í∏∞
req.app.get('io').of('ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§').emit('Ïù¥Î≤§Ìä∏', Î©îÏÑ∏ÏßÄ);

// ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§Ïóê ÏûàÏúºÎ©¥ÏÑú, Í∑∏ÏïàÏóê Î£∏Ïóê ÏûàÎäî Ïú†Ï†ÄÌïúÌÖåÎßå Î≥¥ÎÇ¥Í∏∞
req.app.get('io').of('ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§').to(roomId).emit('Ïù¥Î≤§Ìä∏', Î©îÏÑ∏ÏßÄ);

// ÌäπÏ†ï Ïú†Ï†ÄÌïúÌÖåÎßå Î≥¥ÎÇ¥Í∏∞ (1:1ÎåÄÌôî, Í∑ìÏÜçÎßê)
req.app.get('io').to(socket.id).emit('Ïù¥Î≤§Ìä∏', Î©îÏÑ∏ÏßÄ);

// ÎÇòÎ•º Ï†úÏô∏Ìïú Î™®Îì† Ïú†Ï†ÄÏóêÍ≤å Î≥¥ÎÇ¥Í∏∞
req.app.get('io').broadcast.emit('event_name', msg);

Ï∂úÏ≤ò: https://inpa.tistory.com/entry/SOCKET-üìö-Namespace-Room-Í∏∞Îä• [Inpa Dev üë®‚Äçüíª:Ìã∞Ïä§ÌÜ†Î¶¨]
*/
 
// namespace /chatÏóê Ï†ëÏÜçÌïúÎã§.
var chat = io.of('/chat').on('connection', function(socket) {
 
    // Î£∏ ÏÉùÏÑ±
    socket.on('create', function(data) {

        var _CHAT_ROOM_ID      = data.CHAT_ROOM_ID;
        var _CHAT_ROOM_TITLE   = data.CHAT_ROOM_TITLE;
        var _CHAT_ROOM_SUBJECT = data.CHAT_ROOM_SUBJECT;
        var _CHAT_ROOM_OPEN_GBN = data.CHAT_ROOM_OPEN_GBN;
        var _CHAT_ROOM_OWNER_ID = data.CHAT_ROOM_OWNER_ID;
        var _CHAT_ROOM_OWNER_NM = data.CHAT_ROOM_OWNER_NM;

        _CHAT_ROOM_ID = socket.CHAT_ROOM_ID = "lina_" + uuid4();

        //DBÏóê ÏÉùÏÑ±Îêú Î∞©ÏùÑ Îì±Î°ùÌï®

        var execute_result = { result : "OK", rows : [] };
        var sql = "SP_CM_CHAT_CD";
      
        new mssql.connect(mssql_connect_config).then(() => {
          const request = new mssql.Request();
          request.input('P_CHAT_ROOM_ID', mssql.VarChar(100), _CHAT_ROOM_ID)
          request.input('P_CHAT_ROOM_TITLE', mssql.VarChar(100), _CHAT_ROOM_TITLE)
          request.input('P_CHAT_ROOM_SUBJECT', mssql.VarChar(100), _CHAT_ROOM_SUBJECT)
          request.input('P_CHAT_ROOM_OPEN_GBN', mssql.VarChar(100), _CHAT_ROOM_OPEN_GBN)
          request.input('P_CHAT_ROOM_OWNER_ID', mssql.VarChar(100), _CHAT_ROOM_OWNER_ID)
          request.input('P_CHAT_ROOM_OWNER_NM', mssql.VarChar(100), _CHAT_ROOM_OWNER_NM)
          request.input('P_GBN', mssql.VarChar(100), "C")
          request.output('P_RST_MSG', mssql.VarChar(4000))
          request.execute(sql).then((result) => { 
              //var rows = JSON.parse(JSON.stringify(result));

              //Ïò§Î•òÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÏàòÌñâ
              if(result.output.P_RST_MSG == "OK")
              {
                  chat.emit('create', { "RESULT" : "OK", "CHAT_ROOM_ID" : _CHAT_ROOM_ID });
              }
              else
              {
                  chat.emit('create', { "RESULT" : result.output.P_RST_MSG, "CHAT_ROOM_ID" : "" });
              }
          }).catch((err) => {
              console.log('Error executing sp ', err.message);
              chat.emit('create', err.message );
          });
        }).catch((err) => {
            console.log('DB Error ', err.message);
            chat.emit('create', err.message );
        });            
    });

    // Î£∏ Ï°∞Ïù∏
    socket.on('join', function(data) {
        var _CHAT_ROOM_ID      = data.CHAT_ROOM_ID;
        var _CHAT_ROOM_TITLE   = data.CHAT_ROOM_TITLE;
        var _CHAT_ROOM_SUBJECT = data.CHAT_ROOM_SUBJECT;
        var _CHAT_ROOM_OPEN_GBN = data.CHAT_ROOM_OPEN_GBN;
        var _CHAT_ROOM_OWNER_ID = data.CHAT_ROOM_OWNER_ID;
        var _CHAT_ROOM_OWNER_NM = data.CHAT_ROOM_OWNER_NM;   

        socket.CHAT_ROOM_ID = data.CHAT_ROOM_ID;
        socket.CHAT_ROOM_TITLE = data.CHAT_ROOM_TITLE;
        socket.CHAT_ROOM_OWNER_ID = data.CHAT_ROOM_OWNER_ID;
        socket.CHAT_ROOM_OWNER_NM = data.CHAT_ROOM_OWNER_NM;
   
        //DBÏóê ÏÉùÏÑ±Îêú Î∞©Ïù¥ ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† Ï∞∏Ïó¨ÏûêÎ°ú Îì±Î°ù
        var sql = "SP_CM_CHAT_JOIN_CD";

        new mssql.connect(mssql_connect_config).then(() => {
          const request = new mssql.Request();
          request.input('P_CHAT_ROOM_ID', mssql.VarChar(100), _CHAT_ROOM_ID)
          request.input('P_USERID', mssql.VarChar(100), data.CHAT_ROOM_OWNER_ID)
          request.input('P_GBN', mssql.VarChar(100), "C")
          request.output('P_USR_LST', mssql.VarChar(4000))
          request.output('P_RST_MSG', mssql.VarChar(4000))
          request.execute(sql).then((result) => { 
  
              //Ïò§Î•òÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÏàòÌñâ
              if(result.output.P_RST_MSG == "OK")
              {
                // roomÏóê joinÌïúÎã§
                socket.join(socket.CHAT_ROOM_ID);
          
                // Ï†ëÏÜçÎêú Î™®Îì† ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÍ≤å Î©îÏãúÏßÄÎ•º Ï†ÑÏÜ°ÌïúÎã§
                chat.to(socket.CHAT_ROOM_ID).emit('join', _CHAT_ROOM_OWNER_NM + "ÎãòÏù¥ ÏûÖÏû•ÌïòÏÖ®ÏäµÎãàÎã§.");
              }
              else
              {
                  // roomÏóê joinÌïúÎã§
                  socket.join(socket.CHAT_ROOM_ID);
            
                  // Ï†ëÏÜçÎêú Î™®Îì† ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÍ≤å Î©îÏãúÏßÄÎ•º Ï†ÑÏÜ°ÌïúÎã§
                  chat.to(socket.CHAT_ROOM_ID).emit('join', "Ïò§Î•òÎ∞úÏÉù: " + result.output.P_RST_MSG);
              }
          }).catch((err) => {
              console.log('Error executing sp ', err.message);
              chat.to(socket.CHAT_ROOM_ID).emit('join', "Ïò§Î•òÎ∞úÏÉù: " + result.output.P_RST_MSG);

          });
        }).catch((err) => {
            console.log('DB Error ', err.message);
            chat.to(socket.CHAT_ROOM_ID).emit('join', "Ïò§Î•òÎ∞úÏÉù: " + result.output.P_RST_MSG);
        });         
    });

    // Î£∏ ÎÇòÍ∞ÄÍ∏∞
    socket.on('leave', function(data) {
        console.log('leave room from client: ', data);

        var _CHAT_ROOM_ID = socket.CHAT_ROOM_ID = data.CHAT_ROOM_ID;
        var _CHAT_ROOM_TITLE = socket.CHAT_ROOM_TITLE = data.CHAT_ROOM_TITLE;
        var _CHAT_ROOM_OWNER_ID = socket.CHAT_ROOM_OWNER_ID = data.CHAT_ROOM_OWNER_ID;
        var _CHAT_ROOM_OWNER_NM = socket.CHAT_ROOM_OWNER_NM = data.CHAT_ROOM_OWNER_NM;

        socket.leave(socket.CHAT_ROOM_ID);

        //DB Ïóê Îì±Î°ùÎêú Íµ¨ÏÑ±Ïõê ÏÇ≠Ï†ú.
        var sql = "SP_CM_CHAT_JOIN_CD";

        new mssql.connect(mssql_connect_config).then(() => {
          const request = new mssql.Request();
          request.input('P_CHAT_ROOM_ID', mssql.VarChar(100), _CHAT_ROOM_ID)
          request.input('P_USERID', mssql.VarChar(100), _CHAT_ROOM_OWNER_ID)
                request.input('P_GBN', mssql.VarChar(100), "D")
                request.output('P_USR_LST', mssql.VarChar(4000))
                request.output('P_RST_MSG', mssql.VarChar(4000))
          request.execute(sql).then((result) => { 
              console.log("Ï±ÑÌåÖÎ∞© leave : " + result.output.P_RST_MSG);
              console.log("Ï±ÑÌåÖÎ∞© Íµ¨ÏÑ±Ïõê : " + result.output.P_USR_LST);

              var rows = JSON.parse(result.output.P_USR_LST);

              if(rows.length > 0) //Î£∏Ïóê Íµ¨ÏÑ±ÏõêÏù¥ ÏûàÎäî Í≤ΩÏö∞
              {
                  // roomÏóê joinÎêòÏñ¥ ÏûàÎäî ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÍ≤å Î©îÏãúÏßÄÎ•º Ï†ÑÏÜ°ÌïúÎã§
                  chat.to(socket.CHAT_ROOM_ID).emit('leave', { "CHAT_ROOM_USER" : _CHAT_ROOM_OWNER_ID, "CHAT_ROOM_USER_NM" : _CHAT_ROOM_OWNER_NM });

              }
              else //Î£∏Ïóê Íµ¨ÏÑ±ÏõêÏù¥ ÏóÜÎäî Í≤ΩÏö∞ Î∞©ÏÇ≠Ï†ú
              {
                  io.in(_CHAT_ROOM_ID).socketsLeave(_CHAT_ROOM_ID);
                  var roomList = Array.from(socket.adapter.rooms.keys());

                  new mssql.connect(mssql_connect_config).then(() => {
                    const request = new mssql.Request();
                    request.input('P_CHAT_ROOM_ID', mssql.VarChar(100), _CHAT_ROOM_ID)
                    request.input('P_CHAT_ROOM_TITLE', mssql.VarChar(100), _CHAT_ROOM_TITLE)
                    request.input('P_CHAT_ROOM_SUBJECT', mssql.VarChar(100), "")
                    request.input('P_CHAT_ROOM_OPEN_GBN', mssql.VarChar(100), "")
                    request.input('P_CHAT_ROOM_OWNER_ID', mssql.VarChar(100), _CHAT_ROOM_OWNER_ID)
                    request.input('P_CHAT_ROOM_OWNER_NM', mssql.VarChar(100), _CHAT_ROOM_OWNER_NM)
                    request.input('P_GBN', mssql.VarChar(100), "D")
                    request.output('P_RST_MSG', mssql.VarChar(4000))
                    request.execute("SP_CM_CHAT_CD").then((result) => { 
                        console.log("Î∞©ÏÇ≠Ï†ú : " + result.output.P_RST_MSG);
                        
                        //Î©îÏãúÏßÄÎ•º Ï†ÑÏÜ°Ìïú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î•º Ï†úÏô∏Ìïú Î™®Îì† ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÍ≤å Î©îÏãúÏßÄÎ•º Ï†ÑÏÜ°ÌïúÎã§
                        socket.broadcast.emit('refresh room', "OK");
                         
                    }).catch((err) => {
                        console.log('Error executing sp ', err.message);

                    });
                  }).catch((err) => {
                      console.log('DB Error ', err.message);

                  });       
              }
          }).catch((err) => {
            console.log("Error executing sp " + err.message);
 
          });
        }).catch((err) => {
            console.log("DB Error " + err.message);
        });
    });

    socket.on('message', function(data) {
        console.log('message from client: ', data);

        var _CHAT_ROOM_ID = socket.CHAT_ROOM_ID = data.CHAT_ROOM_ID;
        var _CHAT_ROOM_TITLE = socket.CHAT_ROOM_TITLE = data.CHAT_ROOM_TITLE;
        var _CHAT_ROOM_OWNER_ID = socket.CHAT_ROOM_OWNER_ID = data.CHAT_ROOM_OWNER_ID;
        var _CHAT_ROOM_OWNER_NM = socket.CHAT_ROOM_OWNER_NM = data.CHAT_ROOM_OWNER_NM;
        var _msg =  data.msg;

        // roomÏóê joinÌïúÎã§
        socket.join(socket.CHAT_ROOM_ID);
        // roomÏóê joinÎêòÏñ¥ ÏûàÎäî ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÍ≤å Î©îÏãúÏßÄÎ•º Ï†ÑÏÜ°ÌïúÎã§
        chat.to(socket.CHAT_ROOM_ID).emit('message', { "CHAT_ROOM_USER" : _CHAT_ROOM_OWNER_ID, "MSG" : _CHAT_ROOM_OWNER_NM + ":" + _msg});    
    });


    socket.on('getRooms', function() {
      console.log(socket.rooms);
      //socket.emit('rooms', io.sockets.adapter.rooms);
      var roomList = Array.from(socket.adapter.rooms.keys());

      socket.emit('getRooms', roomList);
    });

    // ÎîîÏä§Ïª§ÎÑ•Ìä∏Îê†Îïå ÏàòÌñâÌï† ÌîÑÎ°úÏÑ∏Ïä§ ÎÇòÏó¥
    socket.on('disconnecting', function() {
    });

    socket.on('user left', function() {

/*    var name = socket.name = data.name;
      var room = socket.room = data.room;

      socket.disconnect(); 
      chat.to(room).emit('forceDisconnect', " ÎãòÏù¥ Ï†ëÏÜçÏùÑ Ìï¥Ï†ú ÌñàÏäµÎãàÎã§.");
*/
      console.log("Ìï¥Ï†úÏã†Ï≤≠");
      var self = this;
      var _room = self.room;

      chat.to(_room).emit('user left', _room + ' left');
 
    })
});

const publicVapidKey = 'BCWme85WpMZT7XwHZXiwG2iAAg7u1g-Dxth_HaYxwL5mWkkWnffar3SoGowDQR1A667cax0svUrCA-bxeqEAlGo';
const privateVapidKey = '2rrv4a_dVauiKyd59JBespSf-mMS4WDmctn1ZfQereY';

webpush.setVapidDetails(
  "mailto:fotolog@nate.com",
  publicVapidKey,
  privateVapidKey
);

// Subscribe Route
app.post("/subscribe", (req, res) => {
  //Get pushSubscription Object
  const subscription = req.body;

  // Send 201 - resource created
  res.status(201).json({});

  // Create payload
  const payload = JSON.stringify({ title: "ÏÑúÎπÑÏä§ ÏïåÎ¶ºÎ©îÏùº ÎèÑÏ∞©" });

  // Pass Object into sendNotification
  webpush
      .sendNotification(subscription, payload)
      .catch((err) => console.error(err));
});

const push_port = 8082;

app.listen(push_port, () => console.log("push server started on port " + push_port));
 

 

 